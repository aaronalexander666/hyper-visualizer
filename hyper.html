<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HyperCalc Pro – Fixed Version</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/expr-eval@2.0.2/dist/bundle.min.js"></script>
<style>
    :root {
        --bg: #000;
        --panel: rgba(20,20,40,0.85);
        --primary: #00ffcc;
        --accent: #ff00aa;
        --text: #eee;
        --muted: #aaa;
    }
    body {
        margin:0;
        height:100vh;
        background:var(--bg);
        color:var(--text);
        font-family: system-ui, sans-serif;
        overflow:hidden;
        display:flex;
    }
    #canvas {
        position:absolute;
        inset:0;
        width:100%;
        height:100%;
        background:#000;
    }
    aside {
        width:340px;
        background:var(--panel);
        backdrop-filter:blur(12px);
        padding:20px;
        overflow-y:auto;
        z-index:10;
    }
    h1 {
        font-size:1.4rem;
        margin:0 0 8px;
        color:var(--primary);
    }
    .subtitle { font-size:0.9rem; color:var(--muted); margin-bottom:16px; }
    textarea {
        width:100%;
        height:70px;
        background:#111;
        border:1px solid #444;
        color:#ffcc00;
        font-family:monospace;
        padding:8px;
        border-radius:6px;
        resize:none;
    }
    select, input[type=range], button {
        width:100%;
        margin:8px 0;
        padding:8px;
        background:#111;
        color:var(--text);
        border:1px solid #444;
        border-radius:6px;
    }
    button {
        background:var(--primary);
        color:black;
        font-weight:bold;
        cursor:pointer;
    }
    button.secondary { background:#444; color:white; }
    .hud {
        position:absolute;
        top:12px;
        right:12px;
        background:rgba(0,0,0,0.7);
        backdrop-filter:blur(8px);
        padding:6px 12px;
        border-radius:6px;
        font-family:monospace;
        font-size:0.85rem;
    }
    #toast {
        position:fixed;
        bottom:16px;
        right:16px;
        background:rgba(0,0,0,0.9);
        color:white;
        padding:10px 16px;
        border-radius:6px;
        z-index:100;
        opacity:0;
        transition:opacity 0.4s;
    }
</style>
</head>
<body>

<canvas id="canvas"></canvas>

<aside>
    <h1>HyperCalc Pro</h1>
    <div class="subtitle">Simple N-D Visualizer</div>

    <div style="margin:16px 0">
        <strong>Equation</strong><br>
        <textarea id="equation">sin(x*2)*cos(y*2)+sin(z+t)</textarea>
    </div>

    <div style="margin:12px 0">
        <strong>Target</strong>
        <select id="target">
            <option value="color">Color</option>
            <option value="displace">Displace</option>
            <option value="size">Size</option>
        </select>
    </div>

    <div style="margin:16px 0">
        <button id="compile">Compile & Run</button>
        <button class="secondary" id="validate">Check Syntax</button>
    </div>

    <div style="margin-top:12px">
        <strong>Presets:</strong><br>
        <button class="secondary" data-eq="sin(x*y-t)+cos(z*t)">Wave</button>
        <button class="secondary" data-eq="sin(sqrt(x*x+y*y)-t*3)">Ripple</button>
        <button class="secondary" data-eq="sin(x*3)+sin(y*3)+sin(z*3)">Noise</button>
    </div>

    <div style="margin:20px 0 8px">Dimensions: <span id="dim">4</span>D</div>
    <input type="range" id="dims" min="3" max="6" value="4" step="1">

    <div style="margin:12px 0 8px">Particles: <span id="pcount">1200</span></div>
    <input type="range" id="pcount-slider" min="400" max="3000" value="1200" step="100">

    <div style="margin:12px 0 8px">Time: <span id="tspeed">1.0</span></div>
    <input type="range" id="time-slider" min="0" max="5" value="1" step="0.2">

    <div style="margin-top:16px">
        <button class="secondary" id="pause">Pause</button>
        <button class="secondary" id="reset">Reset View</button>
    </div>
</aside>

<div class="hud">
    FPS: <span id="fps">—</span> • <span id="eqtext">sin(x*2)...</span>
</div>

<div id="toast"></div>

<script>
// ──────────────────────────────────────────────
const canvas = document.getElementById('canvas');
const ctx = canvas?.getContext('2d');

if (!canvas || !ctx) {
    document.body.innerHTML += '<div style="color:red;position:fixed;top:20px;left:20px;background:#300;padding:12px;border-radius:8px;">ERROR: Canvas not supported or failed to initialize</div>';
    throw new Error("Canvas failed");
}

let W, H;
let particles = [];
let time = 0;
let rotX = 0, rotY = 0, rotXW = 0;
let paused = false;

let equation = "sin(x*2)*cos(y*2)+sin(z+t)";
let target = "color";
let dimensions = 4;
let particleCount = 1200;
let timeScale = 1.0;

const parser = new exprEval.Parser();

// Resize handler
function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

// Generate particles
function createParticles() {
    particles = [];
    for(let i = 0; i < particleCount; i++) {
        particles.push({
            x: (Math.random()-0.5)*10,
            y: (Math.random()-0.5)*10,
            z: (Math.random()-0.5)*10,
            w: (Math.random()-0.5)*5
        });
    }
}
createParticles();

// Safe evaluation
function evalSafe(x,y,z,t,r) {
    try {
        const v = parser.evaluate(equation, {x,y,z,t,r});
        return isFinite(v) && !isNaN(v) ? v : 0;
    } catch {
        return 0;
    }
}

// Main draw loop
function draw() {
    ctx.fillStyle = 'rgba(0,0,0,0.35)';
    ctx.fillRect(0,0,W,H);

    if (!paused) {
        time += 0.018 * timeScale;
        rotXW += 0.0035;
    }

    ctx.globalCompositeOperation = 'lighter';

    const proj = [];

    for (const p of particles) {
        const r = Math.sqrt(p.x*p.x + p.y*p.y + p.z*p.z);
        let v = evalSafe(p.x, p.y, p.z, time, r);

        let tx = p.x, ty = p.y, tz = p.z, tw = p.w;

        if (target === 'displace') {
            const d = Math.max(-5, Math.min(5, v));
            tz += d;
            tw += d;
        }

        if (dimensions >= 4) {
            const c = Math.cos(rotXW);
            const s = Math.sin(rotXW);
            const nx = tx * c - tw * s;
            const nw = tx * s + tw * c;
            tx = nx;
            tw = nw;
        }

        const d4 = 6;
        const s3 = dimensions >= 4 ? d4 / (d4 - tw) : 1;

        let x3 = tx * s3;
        let y3 = ty * s3;
        let z3 = tz * s3;

        // Simple camera rotation
        let rx = x3 * Math.cos(rotY) - z3 * Math.sin(rotY);
        let rz = x3 * Math.sin(rotY) + z3 * Math.cos(rotY);
        x3 = rx; z3 = rz;

        let ry = y3 * Math.cos(rotX) - z3 * Math.sin(rotX);
        rz = y3 * Math.sin(rotX) + z3 * Math.cos(rotX);
        y3 = ry; z3 = rz;

        const fov = 900;
        const scale = fov / (8 + z3);

        if (scale > 0) {
            proj.push({
                x: Math.round(W/2 + x3 * scale),
                y: Math.round(H/2 + y3 * scale),
                depth: z3,
                scale: scale * s3,
                v
            });
        }
    }

    proj.sort((a,b) => b.depth - a.depth);

    for (const p of proj) {
        let alpha = Math.max(0.18, 1 - p.depth/35);
        let sz = 2.8 * p.scale;

        if (target === 'size') {
            sz *= Math.max(0.4, Math.abs(p.v)*0.9 + 0.6);
        }

        let h = 210, s = 90, l = 65;
        if (target === 'color') {
            const n = Math.atan(p.v) / Math.PI;
            h = 200 + n * 140;
        }

        ctx.fillStyle = `hsla(\( {h}, \){s}%,\( {l}%, \){alpha})`;
        ctx.shadowBlur = 10;
        ctx.shadowColor = ctx.fillStyle;

        ctx.beginPath();
        ctx.arc(p.x, p.y, sz, 0, Math.PI*2);
        ctx.fill();
    }

    ctx.globalCompositeOperation = 'source-over';
    ctx.shadowBlur = 0;

    requestAnimationFrame(draw);
}

// Start rendering immediately
draw();

// Controls
document.getElementById('compile').onclick = () => {
    const txt = document.getElementById('equation').value.trim();
    try {
        parser.parse(txt);
        equation = txt;
        document.getElementById('eqtext').textContent = txt.slice(0,12)+(txt.length>12?'...':'');
    } catch(e) {
        alert('Invalid equation syntax');
    }
};

document.getElementById('validate').onclick = () => {
    try {
        parser.parse(document.getElementById('equation').value);
        alert('Syntax OK');
    } catch(e) {
        alert('Syntax error');
    }
};

document.querySelectorAll('[data-eq]').forEach(b => {
    b.onclick = () => {
        const eq = b.dataset.eq;
        document.getElementById('equation').value = eq;
        equation = eq;
        document.getElementById('eqtext').textContent = eq.slice(0,12)+'...';
    };
});

document.getElementById('target').onchange = e => target = e.target.value;

document.getElementById('dims').oninput = e => {
    dimensions = +e.target.value;
    document.getElementById('dim').textContent = dimensions;
};

document.getElementById('pcount-slider').oninput = e => {
    particleCount = +e.target.value;
    document.getElementById('pcount').textContent = particleCount;
    createParticles();
};

document.getElementById('time-slider').oninput = e => {
    timeScale = +e.target.value;
    document.getElementById('tspeed').textContent = timeScale.toFixed(1);
};

document.getElementById('pause').onclick = () => {
    paused = !paused;
    document.getElementById('pause').textContent = paused ? 'Play' : 'Pause';
};

document.getElementById('reset').onclick = () => {
    rotX = rotY = rotXW = 0;
};

// Mouse drag rotation
let drag = false, lx, ly;
canvas.onmousedown = e => {
    drag = true;
    lx = e.clientX;
    ly = e.clientY;
    canvas.style.cursor = 'grabbing';
};
window.onmouseup = () => { drag = false; canvas.style.cursor = 'crosshair'; };
window.onmousemove = e => {
    if (!drag) return;
    rotY += (e.clientX - lx) * 0.005;
    rotX += (e.clientY - ly) * 0.005;
    lx = e.clientX;
    ly = e.clientY;
};
</script>
</body>
</html>
